test-plugins:
    stage: test
    rules: 
        - !reference [.base_rules, rules]
        - if: '$VERSION != "0.0.0"'
          when: on_success
        - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "web"'
          when: manual
        - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "web"'
          when: on_success
        - when: never
    needs: 
        - job: 'build'
          artifacts: true
    variables:
        #CI_TESTER_BRANCH: "main"
        CI_TESTER_BRANCH: "report-generation"
        SH_PATH: "jobs%2Ftest%2Ftest-plugins.sh"
        SH_BRANCH: "master"
    tags: 
        - Linux
    artifacts:
        reports:
            junit: test-result.xml
    script:
        - 'curl -o "test-plugins.sh" -H "PRIVATE-TOKEN: $API_KEY" "${CI_API_V4_URL}/projects/${CI_INCLUDE_REPO_ID}/repository/files/${SH_PATH}/raw?ref=${SH_BRANCH}"'
        - 'curl -o "CI Tester" -H "PRIVATE-TOKEN: $API_KEY" "${CI_API_V4_URL}/projects/Barwa%2FCI-Tools/jobs/artifacts/$CI_TESTER_BRANCH/raw/build/CI%20Tester?job=build-code-job"'
        - 'chmod 744 ./test-plugins.sh'
        - './test-plugins.sh'
    after_script:
      - mv "/home/scpsl/server_files/test-result.xml" "$CI_PROJECT_DIR/test-result.xml"
